<?php

namespace App\Console\Commands;

use App\Models\SignalSnapshot;
use App\Services\Signal\ModelTrainer;
use Illuminate\Console\Command;

class TrainSignalModel extends Command
{
    protected  = 'signal:train \
        {--symbol=BTC : Symbol to train on} \
        {--limit=5000 : Maximum snapshots} \
        {--epochs=300 : Training epochs} \
        {--lr=0.01 : Learning rate}';

    protected  = 'Train logistic model for AI signal prediction';

    public function __construct(
        protected ModelTrainer 
    ) {
        parent::__construct();
    }

    public function handle(): int
    {
         = strtoupper(->option('symbol') ?? 'BTC');
         = (int) ->option('limit');
         = (int) ->option('epochs');
         = (float) ->option('lr');

         = SignalSnapshot::where('symbol', )
            ->whereNotNull('price_future')
            ->orderBy('generated_at')
            ->limit()
            ->get();

        if (->isEmpty()) {
            ->error('No labeled snapshots available. Run signal:collect and signal:label first.');
            return self::FAILURE;
        }

         = [];
         = [];

        foreach ( as ) {
             = ->features_payload ?? [];
             = ->trainer->extractFeatureVector();
            if (!) {
                continue;
            }

            [] = ;
            [] = ->label_direction === 'UP' ? 1 : 0;
        }

        if (count() < 20) {
            ->error('Not enough usable snapshots to train.');
            return self::FAILURE;
        }

         = ->trainer->train(, , , );

        if (!) {
            ->error('Training failed.');
            return self::FAILURE;
        }

        ->trainer->saveModel();
        ->info(sprintf('Model trained with %d samples and saved (%s).', count(), ['trained_at']));

        return self::SUCCESS;
    }
}
